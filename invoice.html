<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>QRIS Payment</title>
<link href="style.css" rel="stylesheet">
</head>
<body>

<div class="box">
    <h2>Pembayaran QRIS</h2>
    <!-- GIF proses -->
    <img src="https://files.catbox.moe/6967nq.gif" id="processGif" class="process" alt="Proses">

    <!-- QRIS -->
    <img id="qrimg" class="qr" alt="QRIS">

    <div class="detail">
       <b>Detail Transaksi:</b><br>
       Invoice : <span id="inv"></span><br>
       Nominal : Rp <span id="amt"></span><br>
       Metode  : QRIS Auto<br>
       Status  : <span id="sts">MEMPROSES...</span><br>
       Expired : <span id="timer">10:00</span>
    </div>

    <button onclick="checkStatus()">Cek Status</button>
</div>

<script>
const q=new URLSearchParams(location.search);
const id=q.get("id"); 
const amount=q.get("amount");

document.getElementById("inv").innerText=id;
document.getElementById("amt").innerText=amount;
document.getElementById("qrimg").src=`https://api.pakasir.com/anon-payment/qris/${id}.png`;

// LOCALSTORAGE TIMER
const TIMER_KEY = `invoice_timer_${id}`;
let expireTime = localStorage.getItem(TIMER_KEY);
if(!expireTime){
    expireTime = Date.now() + 10*60*1000;
    localStorage.setItem(TIMER_KEY, expireTime);
}

function updateTimer(){
    const now = Date.now();
    let t = Math.floor((expireTime - now)/1000);
    if(t <= 0){
        t = 0;
        document.getElementById("timer").innerText = "00:00";
        clearInterval(timerInterval);
        localStorage.removeItem(TIMER_KEY);
        document.getElementById("sts").innerText = "EXPIRED";
        document.getElementById("processGif").style.display="none";
        return;
    } 
    let m = Math.floor(t/60), s = t%60;
    document.getElementById("timer").innerText = `${m}:${s<10?'0'+s:s}`;
}

const timerInterval = setInterval(updateTimer,1000);
updateTimer();

// STATUS CHECK
async function checkStatus(){
    // simulasi status paid otomatis 15 detik (untuk demo)
    // nanti bisa diganti fetch API
    const fakePaidTime = 15000;
    setTimeout(()=>{
        document.getElementById("sts").innerText = "SUCCESS";
        document.getElementById("processGif").style.display="none";
        localStorage.removeItem(TIMER_KEY);
        window.location=`success.html?id=${id}&amount=${amount}`;
    }, fakePaidTime);
}

// auto cek tiap 5 detik
setInterval(checkStatus,5000);

</script>
</body>
</html>
